# Настройка Webhook для интеграции Яндекс.Маркет → МойСклад

## 1. Запуск сервера

### Локально (для тестирования)
```bash
node index.js
```

Сервер запустится на порту 3000 (или PORT из .env)

### На продакшене (с PM2)
```bash
# Установить PM2 (если еще не установлен)
npm install -g pm2

# Запустить сервер
pm2 start index.js --name yandex-moysklad

# Настроить автозапуск при перезагрузке
pm2 startup
pm2 save

# Просмотр логов
pm2 logs yandex-moysklad

# Перезапуск
pm2 restart yandex-moysklad
```

## 2. Настройка webhook в Яндекс.Продавец

### Шаг 1: Откройте настройки webhook
1. Зайдите в **Яндекс.Продавец**: https://partner.market.yandex.ru/
2. Перейдите в **Настройки** → **API и вебхуки** → **Вебхуки**

### Шаг 2: Создайте webhook для заказов
1. Нажмите **"Создать вебхук"** или **"Добавить"**
2. Заполните поля:
   - **URL**: `https://ваш-домен.ru/webhook` (или IP сервера)
   - **События**: 
     - ✅ Создание заказа (ORDER_CREATED)
     - ✅ Изменение статуса заказа (ORDER_STATUS_UPDATED)
   - **Секретный ключ**: укажите значение из `WEBHOOK_SECRET` в .env (или создайте новый)

### Шаг 3: Сохраните и протестируйте
1. Сохраните webhook
2. Яндекс.Маркет отправит тестовый запрос
3. Проверьте логи сервера

## 3. Проброс порта для локального тестирования

Если хотите протестировать локально, используйте ngrok:

```bash
# Установить ngrok
brew install ngrok  # для macOS
# или скачать с https://ngrok.com/

# Запустить туннель
ngrok http 3000

# Скопировать URL (например: https://abc123.ngrok.io)
# Использовать этот URL в настройках webhook Яндекс.Маркет
```

## 4. Структура webhook от Яндекс.Маркет

### Создание заказа (ORDER_CREATED)
```json
{
  "type": "ORDER_CREATED",
  "order": {
    "id": "12345678",
    "items": [
      {
        "offerId": "1-IxiodciXeIaS5RgRrkC1",
        "count": 2
      }
    ]
  }
}
```

### Изменение статуса (ORDER_STATUS_UPDATED)
```json
{
  "type": "ORDER_STATUS_UPDATED",
  "order": {
    "id": "12345678",
    "status": "PROCESSING",
    "items": [
      {
        "offerId": "1-IxiodciXeIaS5RgRrkC1",
        "count": 2
      }
    ]
  }
}
```

## 5. Что происходит при получении webhook

### ORDER_CREATED (Создание заказа)
1. Сервер получает webhook
2. Проверяет подпись (если настроен WEBHOOK_SECRET)
3. Извлекает товары из заказа
4. Сопоставляет SKU с МойСклад через mapping.json
5. Проверяет, не создан ли уже Заказ покупателя (идемпотентность)
6. Создает **Заказ покупателя** в МойСклад (резервирование товаров)
7. Возвращает HTTP 200

### ORDER_STATUS_UPDATED со статусом PROCESSING/READY_TO_SHIP/DELIVERY
1. Сервер получает webhook
2. Проверяет подпись
3. Извлекает товары из заказа
4. Сопоставляет SKU с МойСклад
5. Ищет соответствующий Заказ покупателя
6. Проверяет, не создана ли уже Отгрузка (идемпотентность)
7. Создает **Отгрузку (Demand)** в МойСклад (списание товаров)
8. Связывает Отгрузку с Заказом покупателя
9. Возвращает HTTP 200

## 6. Проверка работы

### Просмотр логов
```bash
# Если запущено через PM2
pm2 logs yandex-moysklad

# Если запущено напрямую
# Логи выводятся в консоль
```

### Тестовый webhook (локально)
```bash
curl http://localhost:3000/webhook \
  -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "type": "ORDER_CREATED",
    "order": {
      "id": "TEST-12345",
      "items": [
        {
          "offerId": "1-IxiodciXeIaS5RgRrkC1",
          "count": 1
        }
      ]
    }
  }'
```

## 7. Важные моменты

### Маппинг SKU
- В Яндекс.Маркет товары должны иметь `offerId` = `externalCode` из МойСклад
- Проверьте mapping.json - там 860 товаров
- Если товар не найден в маппинге, он будет пропущен с ошибкой в логах

### Идемпотентность
- Повторная отправка webhook не создаст дубликаты
- Система проверяет существование документов по externalNumber

### Безопасность
- Настройте WEBHOOK_SECRET для проверки подписи
- Используйте HTTPS на продакшене
- Не коммитьте .env в git (уже в .gitignore)

## 8. Troubleshooting

### Webhook не приходит
- Проверьте, что сервер запущен и доступен
- Проверьте URL в настройках Яндекс.Маркет
- Проверьте логи сервера

### Ошибка 403 (Forbidden)
- Проверьте WEBHOOK_SECRET в .env
- Убедитесь, что секрет совпадает с настройками в Яндекс.Маркет

### Товары не создаются в МойСклад
- Проверьте mapping.json
- Убедитесь, что offerId в Яндекс.Маркет = externalCode в МойСклад
- Проверьте логи - там будет информация о незамапленных SKU

### Ошибка аутентификации МойСклад
- Проверьте токен в MOYSKLAD_PASSWORD
- Убедитесь, что токен не истек
- Проверьте MOYSKLAD_LOGIN (должен быть admin@vadimvvb011)

## 9. Мониторинг

Рекомендуется настроить мониторинг:
- Доступность endpoint /webhook
- Логи ошибок
- Количество обработанных заказов
- Незамапленные SKU

## 10. Контакты и поддержка

При возникновении проблем проверьте:
1. Логи сервера
2. Настройки webhook в Яндекс.Маркет
3. Файл mapping.json
4. Переменные окружения в .env
