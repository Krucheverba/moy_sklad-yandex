# План реализации

- [-] 1. Исправить систему модулей и зависимости
- [x] 1.1 Обновить package.json для использования CommonJS (убрать "type": "module")
  - Изменить тип модулей с ES modules на CommonJS для согласованности
  - _Требования: 10.1, 10.2_

- [x] 1.2 Добавить недостающие зависимости в package.json
  - Добавить express, body-parser и axios в dependencies
  - _Требования: 10.3, 10.5_

- [x] 1.3 Конвертировать generate-mapping.js в синтаксис CommonJS
  - Заменить import на require()
  - Заменить export на module.exports
  - _Требования: 10.1, 10.2, 10.4_

- [x] 1.4 Написать property-тест для объявления зависимостей
  - **Property 34: Dependency declaration**
  - **Проверяет: Требования 10.3**

- [x] 2. Реализовать проверки идемпотентности в клиенте МойСклад
- [x] 2.1 Добавить функцию поиска существующего Заказа покупателя по External Number
  - Реализовать findCustomerOrderByExternalNumber() с фильтром MoySklad API
  - Корректно обрабатывать ошибки API
  - _Требования: 6.1, 6.5_

- [x] 2.2 Добавить функцию поиска существующей Отгрузки по External Number
  - Реализовать findDemandByExternalNumber() с фильтром MoySklad API
  - Корректно обрабатывать ошибки API
  - _Требования: 6.3, 6.5_

- [x] 2.3 Написать property-тест для идемпотентности Заказа покупателя
  - **Property 18: Customer Order idempotency check**
  - **Property 19: Customer Order duplicate prevention**
  - **Проверяет: Требования 6.1, 6.2**

- [x] 2.4 Написать property-тест для идемпотентности Отгрузки
  - **Property 20: Demand idempotency check**
  - **Property 21: Demand duplicate prevention**
  - **Проверяет: Требования 6.3, 6.4**

- [x] 3. Реализовать связывание Заказа покупателя и Отгрузки
- [x] 3.1 Обновить createDemand для поиска соответствующего Заказа покупателя
  - Вызывать findCustomerOrderByExternalNumber перед созданием Demand
  - Включить ссылку customerOrder в тело Demand, если найден
  - Логировать предупреждение, если Заказ покупателя не найден
  - _Требования: 7.1, 7.2, 7.3_

- [ ]* 3.2 Написать property-тест для связывания Отгрузки
  - **Property 23: Customer Order search for linking**
  - **Property 24: Demand linking when Customer Order found**
  - **Property 25: Demand creation without link**
  - **Проверяет: Требования 7.1, 7.2, 7.3**

- [x] 4. Обновить обработчик webhook для использования проверок идемпотентности
- [x] 4.1 Добавить проверку идемпотентности перед созданием Заказа покупателя
  - Вызывать findCustomerOrderByExternalNumber в handleOrderCreated
  - Пропустить создание, если уже существует, вернуть 200
  - _Требования: 6.1, 6.2_

- [x] 4.2 Добавить проверку идемпотентности перед созданием Отгрузки
  - Вызывать findDemandByExternalNumber в handleLabelPrint
  - Пропустить создание, если уже существует, вернуть 200
  - _Требования: 6.3, 6.4_

- [ ]* 4.3 Написать property-тест для идемпотентности webhook
  - **Property 19: Customer Order duplicate prevention**
  - **Property 21: Demand duplicate prevention**
  - **Проверяет: Требования 6.2, 6.4**

- [x] 5. Реализовать верификацию подписи webhook
- [x] 5.1 Реализовать функцию verifyWebhook с реальной проверкой подписи
  - Проверить наличие переменной окружения WEBHOOK_SECRET
  - Проверить подпись из заголовков webhook (X-Signature или аналогичный)
  - Вернуть false, если верификация не прошла
  - Логировать предупреждение, если WEBHOOK_SECRET не настроен
  - _Требования: 2.1, 2.2, 2.3, 2.4_

- [ ]* 5.2 Написать property-тест для верификации webhook
  - **Property 5: Invalid signatures return 403**
  - **Property 6: Valid signatures allow processing**
  - **Проверяет: Требования 2.2, 2.4**

- [x] 6. Улучшить обработку ошибок и логирование
- [x] 6.1 Добавить структурированное логирование с контекстом
  - Логировать тип события webhook и ID заказа при получении
  - Логировать ошибки с полным контекстом (ID заказа, тип операции)
  - Логировать ошибки MoySklad API с кодом статуса и телом ответа
  - Логировать успех с ID/href сущности
  - _Требования: 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 6.2 Добавить правильную обработку HTTP статус-кодов
  - Возвращать 400 для некорректного JSON
  - Возвращать 403 для неудачной верификации
  - Возвращать 500 для системных ошибок
  - Возвращать 200 для успеха
  - _Требования: 1.3, 1.4, 1.5, 2.2_

- [ ]* 6.3 Написать property-тесты для обработки ошибок
  - **Property 2: Malformed webhooks return 400**
  - **Property 3: Successful processing returns 200**
  - **Property 4: System errors return 500**
  - **Проверяет: Требования 1.3, 1.4, 1.5**

- [ ]* 6.4 Написать property-тесты для логирования
  - **Property 29: Error logging includes context**
  - **Property 30: API error logging includes details**
  - **Property 31: Webhook logging**
  - **Property 32: Success logging**
  - **Проверяет: Требования 9.1, 9.2, 9.3, 9.4**

- [x] 7. Исправить определение события печати ярлыка
- [x] 7.1 Обновить определение типа события для печати ярлыка
  - Определить правильный тип события/статус для печати ярлыка из webhook Яндекса
  - Обновить массив triggerStatuses или проверку типа события
  - _Требования: 5.1, 5.2_

- [x] 7.2 Разделить обработчики ORDER_CREATED и печати ярлыка
  - Создать функцию handleOrderCreated для резервирования
  - Создать функцию handleLabelPrint для отгрузки
  - Направлять события в соответствующий обработчик
  - _Требования: 4.1, 5.1_

- [ ]* 7.3 Написать property-тест для извлечения событий
  - **Property 10: Order item extraction**
  - **Property 15: Label print event extraction**
  - **Проверяет: Требования 4.1, 5.1**

- [x] 8. Улучшить управление конфигурацией
- [x] 8.1 Добавить валидацию обязательных переменных окружения
  - Проверить наличие MOYSKLAD_BASE, MOYSKLAD_LOGIN, MOYSKLAD_PASSWORD
  - Проверить наличие STORE_ID, ORG_ID
  - Завершить работу с ошибкой, если отсутствуют
  - _Требования: 8.1, 8.2_

- [x] 8.2 Добавить загрузку конфигурации при запуске
  - Загрузить и валидировать конфигурацию перед запуском сервера
  - Логировать конфигурацию (без чувствительных значений)
  - _Требования: 8.1, 8.3, 8.4, 8.5_

- [ ]* 8.3 Написать property-тест для использования конфигурации
  - **Property 27: MoySklad API uses environment config**
  - **Property 28: Entity creation uses environment IDs**
  - **Проверяет: Требования 8.4, 8.5**

- [x] 9. Обновить генерацию маппинга товаров
- [x] 9.1 Добавить получение товаров из Яндекс.Маркет API
  - Реализовать функцию для получения списка товаров из Яндекс.Маркет
  - Использовать YANDEX_TOKEN из переменных окружения
  - Извлечь SKU (offerId) из каждого товара
  - _Требования: 3.1, 3.2_

- [x] 9.2 Обновить генерацию маппинга для сопоставления обеих систем
  - Получить товары из МойСклад (уже реализовано)
  - Получить товары из Яндекс.Маркет
  - Сопоставить товары по externalCode (МойСклад) = offerId (Яндекс)
  - Создать маппинг: {yandexSKU: moyskladProductId}
  - _Требования: 3.2, 3.3_

- [x] 9.3 Добавить обработку ошибок в генерацию маппинга
  - Корректно обрабатывать ошибки API обеих систем
  - Валидировать структуру ответов
  - Логировать прогресс и результаты
  - Логировать товары, которые не удалось сопоставить
  - _Требования: 3.1, 3.2_

- [x] 9.4 Добавить валидацию маппинга
  - Проверить существование файла маппинга при запуске сервера
  - Валидировать формат JSON
  - Логировать количество замапленных товаров
  - Предупреждать о пустом маппинге
  - _Требования: 3.4, 3.5_

- [ ]* 9.3 Написать property-тест для генерации маппинга
  - **Property 7: Product field extraction**
  - **Property 8: Mapping entry creation**
  - **Property 9: Mapping JSON validity**
  - **Проверяет: Требования 3.2, 3.3, 3.4**

- [x] 10. Добавить обработку ошибок маппинга SKU
- [x] 10.1 Улучшить обработку незамапленных SKU
  - Логировать детальную ошибку с SKU и ID заказа
  - Продолжать обработку других товаров
  - Возвращать успех, если хотя бы один товар замаплен
  - Возвращать ошибку, если ни один товар не замаплен
  - _Требования: 4.3_

- [ ]* 10.2 Написать property-тест для маппинга SKU
  - **Property 11: SKU to product ID mapping**
  - **Property 12: Unmapped SKU handling**
  - **Проверяет: Требования 4.2, 4.3**

- [x] 11. Обеспечить правильное создание сущностей МойСклад
- [x] 11.1 Проверить формат создания Заказа покупателя
  - Убедиться, что все обязательные поля включены
  - Проверить формат массива positions
  - Протестировать с MoySklad API
  - _Требования: 4.4, 4.5_

- [x] 11.2 Проверить формат создания Отгрузки
  - Убедиться, что все обязательные поля включены
  - Проверить формат массива positions
  - Включить ссылку customerOrder, когда доступна
  - Протестировать с MoySklad API
  - _Требования: 5.4, 5.5, 7.2_

- [ ]* 11.3 Написать property-тесты для создания сущностей
  - **Property 13: Customer Order creation with positions**
  - **Property 14: Customer Order external number**
  - **Property 16: Demand creation with positions**
  - **Property 17: Demand external number**
  - **Проверяет: Требования 4.4, 4.5, 5.4, 5.5**

- [x] 12. Добавить .env в .gitignore
- [x] 12.1 Обновить .gitignore для исключения чувствительных файлов
  - Добавить .env в .gitignore
  - Добавить mapping.json в .gitignore (генерируемый файл)
  - Убедиться, что учетные данные не коммитятся
  - _Требования: 8.1_

- [x] 13. Создать пример файла конфигурации
- [x] 13.1 Создать .env.example с placeholder значениями
  - Включить все обязательные переменные окружения
  - Добавить комментарии, объясняющие каждую переменную
  - Документировать, как получить значения
  - _Требования: 8.1_

- [x] 14. Финальная проверка - Убедиться, что все тесты проходят
  - Убедиться, что все тесты проходят, спросить пользователя при возникновении вопросов.
